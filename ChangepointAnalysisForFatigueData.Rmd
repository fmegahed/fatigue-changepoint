---
title: "Changepoint Analysis For Fatigue Data"
author: "Amir Baghdadi, Fadel Megahed, and Lora Cavuoto"
date: "August 31, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this paper, we attempt to examine whether the use of change-point analysis techniques is appropriate for detecting fatigue based on data captured from wearable sensors. As such, we perform a **secondary data analysis** to the data generated in:

Baghdadi, A., Megahed, F. M., Esfahani, E. T., & Cavuoto, L. A. (2018). A machine learning approach to detect changes in gait parameters following a fatiguing occupational task. *Ergonomics*, 1-14.

# Extracting the Data and Generating the Features 

## Initilization, loading the datasets from Baghdadi et al. (2018), and computing three kinematic features
The snippet below documents the list of **R** libraries that were used in this research. For convenience, we used the pacman package since it allows for installing/loading the needed libraries in one step. 
```{r, load_libraries, message=FALSE, cache=TRUE, error=FALSE}
cat("\014") # clear console
rm(list = ls()) # clear global environment
graphics.off() # close all graphics
library(pacman) # needs to be installed first
p_load(R.matlab,plotly,extrafont,grDevices,
       dplyr,stringr,tidyverse)
```

In the snippet below, we extract the 15 ``.mat" files in the *GitHub* repository. Then, we perform several transformation steps: (a) extracting the data for the first three columns in the matlab arrays; and (b) computing three kinematic features from the data corresponding to these columns. Due to the differences between Matlab and R, this requires two nested *for* loops. The outer loop increments over the number of subjects, while the inner loop increments based on the different number of rows of data for each subject. Please see the comments within the code chunk for more details.

```{r load_data, cache=TRUE}
subject_files <- seq(1, 15)
subject_heights <- c(1.71, 1.77, 1.71, 1.59, 1.69,
                     1.63, 1.60, 1.71, 1.67, 1.78,
                     1.68, 1.55, 1.83, 1.81, 1.89)

# Initilizing a df for summary data on participants
summary_df <- data.frame(matrix(nrow = 15, ncol = 9))
colnames(summary_df) <- c("Subject.Num", "num.rows",
                          "num.cols", "mean.scaled.step.len",
                          "sd.scaled.step.len",
                          "mean.scaled.step.height",
                          "sd.scaled.step.height",
                          "mean.step.duration",
                          "sd.step.duartion")

for (i in 1:length(subject_files)) {
  # Reading the .mat files from GitHub
  raw_data <- readMat(paste0("https://github.com/fmegahed/fatigue-changepoint/blob/master/Data/Raw/Subject",subject_files[i],".mat?raw=true"))
  # Compute the number of cells, and rows in each structered matrix
  raw_data_size <- lengths(raw_data) # num of cells
  num_rows <- raw_data_size / 17 # all data had 17 cols
  # Initilizing the six lists needed for storing the data (we keep track of the top 3 for error checking)
  position_x <- vector("list", length = num_rows)
  position_y <- vector("list", length = num_rows)
  step_time <- vector("list", length = num_rows)
  step_length <- vector("list", length = num_rows)
  step_height <- vector("list", length = num_rows)
  step_duration <- vector("list", length = num_rows)
  
  # Following for loop is needed since R reads the structured array as a nested list. The list containing the data is called "M.i.k" and it transforms/reads the original array --> rowise. This means that our first three features (with the same timestamp) are always seperated with a distance equal to the total number of rows
  for (j in 1:num_rows) {
    position_x[[j]] <- raw_data[["M.i.k"]][[j]]
    position_y[[j]] <- raw_data[["M.i.k"]][[num_rows + j]]
    step_time[[j]] <- raw_data[["M.i.k"]][[2 * num_rows + j]]
    # Computing the three needed kinematic features
    step_length[[j]] <-
      range(position_x[[j]])[2] - range(position_x[[j]])[1]
    step_height[[j]] <-
      range(position_y[[j]])[2] - range(position_y[[j]])[1]
    step_duration[[j]] <-
      range(step_time[[j]])[2] - range(step_time[[j]])[1]
  }
  
  assign(paste0("subject", i, "_features"), data.frame(scaled.step.len = unlist(step_length)/subject_heights[i], scaled.step.height = unlist(step_height) / subject_heights[i], step.duration = unlist(step_duration)))
  
  # Creating a Summary Data Frame
  df_name <- paste0("subject", i, "_features")
  summary_df[i, 1] <- df_name
  summary_df[i, 2] <- get(df_name) %>% nrow()
  summary_df[i, 3] <- get(df_name) %>% ncol()
  summary_df[i, 4] <- get(df_name)[, 1] %>% mean() %>% round(digits = 4)
  summary_df[i, 5] <- get(df_name)[, 1] %>% sd() %>% round(digits = 4)
  summary_df[i, 6] <- get(df_name)[, 2] %>% mean() %>% round(digits = 4)
  summary_df[i, 7] <- get(df_name)[, 2] %>% sd() %>% round(digits = 4)
  summary_df[i, 8] <- get(df_name)[, 3] %>% mean() %>% round(digits = 4)
  summary_df[i, 9] <- get(df_name)[, 3] %>% sd() %>% round(digits = 4)
}
summary_df
rm(raw_data, raw_data_size, i, j, num_rows, subject_files,   subject_heights)
save.image(file = "./Data/RGenerated/FeatureGeneration.RData")
```
Based on the above analyses, we saved the generated data into an R.data file, which can be accessed by clicking on: The data from the above analysis is saved under [FeatureGeneration.RData](https://github.com/fmegahed/fatigue-changepoint/blob/master/Data/RGenerated/FeatureGeneration.RData).

